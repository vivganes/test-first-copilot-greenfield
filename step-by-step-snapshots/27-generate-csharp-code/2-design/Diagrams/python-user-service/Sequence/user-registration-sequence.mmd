---
title: User Registration API Sequence Diagram
---

%% GH Copilot code - starts
sequenceDiagram
    participant Client
    participant UserRegistrationAPI
    participant UserRegistrationService
    participant UserDTO
    participant PasswordHasher
    participant EmailService
    participant DatabaseSessionManager
    participant UserRepository
    participant Logger

    Client->>UserRegistrationAPI: POST /register (user data)
    UserRegistrationAPI->>Logger: Log request
    UserRegistrationAPI->>UserDTO: Validate & map user data
    UserRegistrationAPI->>UserRegistrationService: register_user(user_dto)
    UserRegistrationService->>DatabaseSessionManager: Begin transaction
    UserRegistrationService->>PasswordHasher: Hash password
    UserRegistrationService->>UserRepository: Save user
    UserRepository->>DatabaseSessionManager: Execute insert
    UserRegistrationService->>AddressRepository: Save address (type=Shipping, isDefault=1)
    AddressRepository->>DatabaseSessionManager: Execute insert
    UserRegistrationService->>UserRole: Assign role
    UserRegistrationService->>EmailVerificationService: Generate verification token
    EmailVerificationService->>EmailVerificationTokenRepository: Create token
    EmailVerificationService->>EmailService: Send verification email
    alt Email service fails
        UserRegistrationService->>DatabaseSessionManager: Commit user, address, role, token
        UserRegistrationService->>Logger: Log email failure
    else All succeed
        UserRegistrationService->>DatabaseSessionManager: Commit transaction
    end
    alt Any DB failure
        UserRegistrationService->>DatabaseSessionManager: Rollback transaction
        UserRegistrationService->>Logger: Log failure
    end
    UserRegistrationService->>DatabaseSessionManager: Cleanup session
    UserRegistrationAPI->>Client: Return success or error response
%% GH Copilot code - end
